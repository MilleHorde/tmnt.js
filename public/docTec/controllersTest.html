<!DOCTYPE html>

<html>
<head>
  <title>controllersTest.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">
              
                
                <a class="source" href="controllersTest.html">
                  controllersTest.js
                </a>
              
                
                <a class="source" href="index.html">
                  index.js
                </a>
              
                
                <a class="source" href="ingredients.html">
                  ingredients.js
                </a>
              
                
                <a class="source" href="pizzas.html">
                  pizzas.js
                </a>
              
                
                <a class="source" href="users.html">
                  users.js
                </a>
              
            </div>
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>controllersTest.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-meta">"use strict"</span>;
<span class="hljs-keyword">const</span> models = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../models'</span>);
<span class="hljs-keyword">const</span> chai = <span class="hljs-built_in">require</span>(<span class="hljs-string">'chai'</span>);
<span class="hljs-keyword">const</span> chaiHttp = <span class="hljs-built_in">require</span>(<span class="hljs-string">'chai-http'</span>);
<span class="hljs-keyword">const</span> server = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../server'</span>);
<span class="hljs-keyword">const</span> expect = chai.expect;
<span class="hljs-keyword">const</span> tools = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../tools'</span>);
<span class="hljs-keyword">const</span> config = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../config'</span>);

<span class="hljs-keyword">const</span> socketClient = <span class="hljs-built_in">require</span>(<span class="hljs-string">'socket.io-client'</span>);

chai.use(chaiHttp);

describe(<span class="hljs-string">'Routes --'</span>, () =&gt; {
  before(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
    <span class="hljs-keyword">let</span> self = <span class="hljs-keyword">this</span>;
    self.api = chai.request(server);
  });

  describe(<span class="hljs-string">'/users'</span>, () =&gt; {

    describe(<span class="hljs-string">'/ -- GET tests'</span>, () =&gt; {
      before(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
        <span class="hljs-keyword">let</span> self = <span class="hljs-keyword">this</span>;
        self.user1 = {
          <span class="hljs-attr">firstName</span>: <span class="hljs-string">"test1"</span>,
          <span class="hljs-attr">lastName</span>: <span class="hljs-string">"test1"</span>,
          <span class="hljs-attr">email</span>: <span class="hljs-string">"test1@test.com"</span>,
          <span class="hljs-attr">password</span>: <span class="hljs-string">"Testtest1"</span>
        };
        self.user2 = {
          <span class="hljs-attr">firstName</span>: <span class="hljs-string">"test2"</span>,
          <span class="hljs-attr">lastName</span>: <span class="hljs-string">"test2"</span>,
          <span class="hljs-attr">email</span>: <span class="hljs-string">"test2@test.com"</span>,
          <span class="hljs-attr">password</span>: <span class="hljs-string">"Testtest2"</span>
        };

        <span class="hljs-keyword">return</span> <span class="hljs-built_in">Promise</span>.all([
          models.Pizza.remove({}),
          models.User.remove({}),
          models.Ingredient.remove({})
        ])
          .then(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
            <span class="hljs-keyword">return</span> models.User.create(self.user1);
          })
          .then(<span class="hljs-function">(<span class="hljs-params">user</span>) =&gt;</span> {
            <span class="hljs-keyword">return</span> models.User.create(self.user2);
          })
          .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
            <span class="hljs-keyword">throw</span> (err.response) ? <span class="hljs-built_in">Error</span>(err.response.body.Error) : err;
          })
      });

      it(<span class="hljs-string">"should return two users"</span>, () =&gt; {
        <span class="hljs-keyword">let</span> self = <span class="hljs-keyword">this</span>;
        <span class="hljs-keyword">return</span> self.api
          .get(<span class="hljs-string">'/users'</span>)
          .then(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
            expect(res.statusCode).to.eql(<span class="hljs-number">200</span>);
            expect(res.body.response.length).to.eql(<span class="hljs-number">2</span>);
            res.body.response.forEach(<span class="hljs-function">(<span class="hljs-params">user, index</span>) =&gt;</span> {
              index++;
              expect(user.email).to.eql(self[<span class="hljs-string">"user"</span> + index].email);
              expect(user.lastName).to.eql(self[<span class="hljs-string">"user"</span> + index].lastName);
              expect(user.firstName).to.eql(self[<span class="hljs-string">"user"</span> + index].firstName);
            })
          })
          .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
            <span class="hljs-keyword">throw</span> (err.response) ? <span class="hljs-built_in">Error</span>(err.response.body.Error) : err;
          })
      });

      it(<span class="hljs-string">"should return empty array if no users"</span>, () =&gt; {
        <span class="hljs-keyword">let</span> self = <span class="hljs-keyword">this</span>;
        <span class="hljs-keyword">return</span> models.User.remove({})
          .then(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
            <span class="hljs-keyword">return</span> self.api
              .get(<span class="hljs-string">'/users'</span>)
          })
          .then(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
            expect(res.statusCode).to.eql(<span class="hljs-number">200</span>);
            expect(res.body.response.length).to.eql(<span class="hljs-number">0</span>);
          })
          .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
            <span class="hljs-keyword">throw</span> (err.response) ? <span class="hljs-built_in">Error</span>(err.response.body.Error) : err;
          })
      });
    });

    describe(<span class="hljs-string">'/signup -- POST tests'</span>, () =&gt; {
      before(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
        <span class="hljs-keyword">let</span> self = <span class="hljs-keyword">this</span>;
        self.user1 = {
          <span class="hljs-attr">firstName</span>: <span class="hljs-string">"test1"</span>,
          <span class="hljs-attr">lastName</span>: <span class="hljs-string">"test1"</span>,
          <span class="hljs-attr">email</span>: <span class="hljs-string">"test1@test.com"</span>,
          <span class="hljs-attr">password</span>: <span class="hljs-string">"Testtest1"</span>
        };

        <span class="hljs-keyword">return</span> <span class="hljs-built_in">Promise</span>.all([
          models.Pizza.remove({}),
          models.User.remove({}),
          models.Ingredient.remove({})
        ])

      });

      it(<span class="hljs-string">"should create one user and return token"</span>, () =&gt; {
        <span class="hljs-keyword">let</span> self = <span class="hljs-keyword">this</span>;
        <span class="hljs-keyword">return</span> self.api
          .post(<span class="hljs-string">'/users/signup'</span>)
          .send(self.user1)
          .then(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
            expect(res.statusCode).to.eql(<span class="hljs-number">200</span>);
            <span class="hljs-keyword">return</span> tools.verifyJWTAsync(res.body.response);
          })
          .then(<span class="hljs-function">(<span class="hljs-params">decoded</span>) =&gt;</span> {
            <span class="hljs-keyword">return</span> models.User.findById(decoded.id);
          })
          .then(<span class="hljs-function">(<span class="hljs-params">user</span>) =&gt;</span> {
            expect(user.email).to.eql(self.user1.email);
            expect(user.firstName).to.eql(self.user1.firstName);
            expect(user.lastName).to.eql(self.user1.lastName);
          })
          .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
            <span class="hljs-keyword">throw</span> (err.response) ? <span class="hljs-built_in">Error</span>(err.response.body.Error) : err;
          })
      });

      it(<span class="hljs-string">"should error if required params are not present"</span>, () =&gt; {
        <span class="hljs-keyword">let</span> self = <span class="hljs-keyword">this</span>;
        <span class="hljs-keyword">return</span> self.api
          .post(<span class="hljs-string">'/users/signup'</span>)
          .send({})
          .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
            expect(err.status).to.eql(<span class="hljs-number">500</span>);
            <span class="hljs-keyword">return</span> self.api.post(<span class="hljs-string">'/users/signup'</span>)
              .send({
                <span class="hljs-attr">email</span>: self.user1.email
              })
          })
          .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
            expect(err.status).to.eql(<span class="hljs-number">500</span>);
            <span class="hljs-keyword">return</span> self.api.post(<span class="hljs-string">'/users/signup'</span>)
              .send({
                <span class="hljs-attr">email</span>: self.user1.email,
                <span class="hljs-attr">firstName</span>: self.user1.firstName
              })
          })
          .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
            expect(err.status).to.eql(<span class="hljs-number">500</span>);
            <span class="hljs-keyword">return</span> self.api.post(<span class="hljs-string">'/users/signup'</span>)
              .send({
                <span class="hljs-attr">email</span>: self.user1.email,
                <span class="hljs-attr">lastName</span>: self.user1.lastName,
                <span class="hljs-attr">firstName</span>: self.user1.firstName
              })
          })
          .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
            expect(err.status).to.eql(<span class="hljs-number">500</span>);
            <span class="hljs-keyword">return</span> self.api.post(<span class="hljs-string">'/users/signup'</span>)
              .send({
                <span class="hljs-attr">email</span>: self.user1.email,
                <span class="hljs-attr">lastName</span>: self.user1.lastName,
                <span class="hljs-attr">password</span>: self.user1.password
              })
          })
          .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
            expect(err.status).to.eql(<span class="hljs-number">500</span>);
          })
      });

      it(<span class="hljs-string">"should error if params haven't good format -- see dto in constants for details"</span>, () =&gt; {
        <span class="hljs-keyword">let</span> self = <span class="hljs-keyword">this</span>;
        <span class="hljs-keyword">return</span> self.api
          .post(<span class="hljs-string">'/users/signup'</span>)
          .send({<span class="hljs-attr">firstName</span>: <span class="hljs-number">1</span>})
          .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
            expect(err.status).to.eql(<span class="hljs-number">500</span>);
            <span class="hljs-keyword">return</span> self.api.post(<span class="hljs-string">'/users/signup'</span>)
              .send({
                <span class="hljs-attr">email</span>: <span class="hljs-string">"test1.com"</span>
              })
          })
          .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
            expect(err.status).to.eql(<span class="hljs-number">500</span>);
            <span class="hljs-keyword">return</span> self.api.post(<span class="hljs-string">'/users/signup'</span>)
              .send({
                <span class="hljs-attr">lastName</span>: <span class="hljs-number">2</span>
              })
          })
          .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
            expect(err.status).to.eql(<span class="hljs-number">500</span>);
            <span class="hljs-keyword">return</span> self.api.post(<span class="hljs-string">'/users/signup'</span>)
              .send({
                <span class="hljs-attr">password</span>: <span class="hljs-string">"12222"</span>
              })
          })
          .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
            expect(err.status).to.eql(<span class="hljs-number">500</span>);
            <span class="hljs-keyword">return</span> self.api.post(<span class="hljs-string">'/users/signup'</span>)
              .send({
                <span class="hljs-attr">password</span>: <span class="hljs-number">12</span>
              })
          })
          .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
            expect(err.status).to.eql(<span class="hljs-number">500</span>);
          })
      });
    });

    describe(<span class="hljs-string">'/signin -- POST tests'</span>, () =&gt; {
      before(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
        <span class="hljs-keyword">let</span> self = <span class="hljs-keyword">this</span>;
        self.user1 = {
          <span class="hljs-attr">firstName</span>: <span class="hljs-string">"test1"</span>,
          <span class="hljs-attr">lastName</span>: <span class="hljs-string">"test1"</span>,
          <span class="hljs-attr">email</span>: <span class="hljs-string">"test1@test.com"</span>,
          <span class="hljs-attr">password</span>: <span class="hljs-string">"Testtest1"</span>
        };

        <span class="hljs-keyword">return</span> <span class="hljs-built_in">Promise</span>.all([
          models.Pizza.remove({}),
          models.User.remove({}),
          models.Ingredient.remove({})
        ])
          .then(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
            <span class="hljs-keyword">return</span> models.User.specials.signup(self.user1)
          })
          .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
            <span class="hljs-keyword">throw</span> (err.response) ? <span class="hljs-built_in">Error</span>(err.response.body.Error) : err;
          })
      });

      it(<span class="hljs-string">"should connect one user and return token"</span>, () =&gt; {
        <span class="hljs-keyword">let</span> self = <span class="hljs-keyword">this</span>;
        <span class="hljs-keyword">return</span> self.api
          .post(<span class="hljs-string">'/users/signin'</span>)
          .send({
            <span class="hljs-attr">email</span>: self.user1.email,
            <span class="hljs-attr">password</span>: self.user1.password
          })
          .then(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
            expect(res.statusCode).to.eql(<span class="hljs-number">200</span>);
            <span class="hljs-keyword">return</span> tools.verifyJWTAsync(res.body.response);
          })
          .then(<span class="hljs-function">(<span class="hljs-params">decoded</span>) =&gt;</span> {
            <span class="hljs-keyword">return</span> models.User.findById(decoded.id);
          })
          .then(<span class="hljs-function">(<span class="hljs-params">user</span>) =&gt;</span> {
            expect(user.email).to.eql(self.user1.email);
            expect(user.firstName).to.eql(self.user1.firstName);
            expect(user.lastName).to.eql(self.user1.lastName);
          })
          .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
            <span class="hljs-keyword">throw</span> (err.response) ? <span class="hljs-built_in">Error</span>(err.response.body.Error) : err;
          })
      });

      it(<span class="hljs-string">"should error if required params are not present"</span>, () =&gt; {
        <span class="hljs-keyword">let</span> self = <span class="hljs-keyword">this</span>;
        <span class="hljs-keyword">return</span> self.api
          .post(<span class="hljs-string">'/users/signin'</span>)
          .send({})
          .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
            expect(err.status).to.eql(<span class="hljs-number">500</span>);
            <span class="hljs-keyword">return</span> self.api.post(<span class="hljs-string">'/users/signin'</span>)
              .send({
                <span class="hljs-attr">email</span>: self.user1.email
              })
          })
          .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
            expect(err.status).to.eql(<span class="hljs-number">500</span>);
            <span class="hljs-keyword">return</span> self.api.post(<span class="hljs-string">'/users/signin'</span>)
              .send({
                <span class="hljs-attr">password</span>: self.user1.password
              })
          })
          .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
            expect(err.status).to.eql(<span class="hljs-number">500</span>);
          })
      });

      it(<span class="hljs-string">"should error if params haven't good format -- see dto in constants for details"</span>, () =&gt; {
        <span class="hljs-keyword">let</span> self = <span class="hljs-keyword">this</span>;
        <span class="hljs-keyword">return</span> self.api
          .post(<span class="hljs-string">'/users/signin'</span>)
          .send({<span class="hljs-attr">email</span>: <span class="hljs-number">1</span>})
          .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
            expect(err.status).to.eql(<span class="hljs-number">500</span>);
            <span class="hljs-keyword">return</span> self.api.post(<span class="hljs-string">'/users/signin'</span>)
              .send({
                <span class="hljs-attr">email</span>: <span class="hljs-string">"test1.com"</span>
              })
          })
          .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
            expect(err.status).to.eql(<span class="hljs-number">500</span>);
            <span class="hljs-keyword">return</span> self.api.post(<span class="hljs-string">'/users/signin'</span>)
              .send({
                <span class="hljs-attr">password</span>: <span class="hljs-number">2</span>
              })
          })
          .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
            expect(err.status).to.eql(<span class="hljs-number">500</span>);
            <span class="hljs-keyword">return</span> self.api.post(<span class="hljs-string">'/users/signin'</span>)
              .send({
                <span class="hljs-attr">password</span>: <span class="hljs-string">"12222"</span>
              })
          })
          .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
            expect(err.status).to.eql(<span class="hljs-number">500</span>);
            <span class="hljs-keyword">return</span> self.api.post(<span class="hljs-string">'/users/signin'</span>)
              .send({
                <span class="hljs-attr">password</span>: <span class="hljs-number">12</span>
              })
          })
          .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
            expect(err.status).to.eql(<span class="hljs-number">500</span>);
          })
      });
    });

    describe(<span class="hljs-string">'/:id -- PUT tests'</span>, () =&gt; {
      before(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
        <span class="hljs-keyword">let</span> self = <span class="hljs-keyword">this</span>;
        self.user1 = {
          <span class="hljs-attr">firstName</span>: <span class="hljs-string">"test1"</span>,
          <span class="hljs-attr">lastName</span>: <span class="hljs-string">"test1"</span>,
          <span class="hljs-attr">email</span>: <span class="hljs-string">"test1@test.com"</span>,
          <span class="hljs-attr">password</span>: <span class="hljs-string">"Testtest1"</span>
        };

        <span class="hljs-keyword">return</span> <span class="hljs-built_in">Promise</span>.all([
          models.Pizza.remove({}),
          models.User.remove({}),
          models.Ingredient.remove({})
        ])
          .then(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
            <span class="hljs-keyword">return</span> models.User.specials.signup(self.user1)
          })
          .then(<span class="hljs-function">(<span class="hljs-params">user</span>) =&gt;</span> {
            <span class="hljs-keyword">return</span> self.api.post(<span class="hljs-string">'/users/signin'</span>)
              .send({
                <span class="hljs-attr">email</span>: self.user1.email,
                <span class="hljs-attr">password</span>: self.user1.password
              })
          })
          .then(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
            self.user1.token = res.body.response;
            <span class="hljs-keyword">return</span> tools.verifyJWTAsync(res.body.response);
          })
          .then(<span class="hljs-function">(<span class="hljs-params">decoded</span>) =&gt;</span> {
            self.user1._id = decoded.id;
          })
          .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
            <span class="hljs-keyword">throw</span> (err.response) ? <span class="hljs-built_in">Error</span>(err.response.body.Error) : err;
          })
      });

      it(<span class="hljs-string">"should modify user who is passed in param and return user updated"</span>, () =&gt; {
        <span class="hljs-keyword">let</span> self = <span class="hljs-keyword">this</span>;
        <span class="hljs-keyword">return</span> self.api
          .put(<span class="hljs-string">'/users/'</span> + self.user1._id)
          .send({
            <span class="hljs-attr">password</span>: <span class="hljs-string">"Azerty123"</span>
          })
          .set(<span class="hljs-string">'Authorization'</span>, self.user1.token)
          .then(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
            expect(res.statusCode).to.eql(<span class="hljs-number">200</span>);
            <span class="hljs-keyword">return</span> self.api.post(<span class="hljs-string">'/users/signin'</span>)
              .send({
                <span class="hljs-attr">email</span>: self.user1.email,
                <span class="hljs-attr">password</span>: <span class="hljs-string">"Azerty123"</span>
              });
          })
          .then(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
            expect(res.status).to.eql(<span class="hljs-number">200</span>);
            <span class="hljs-keyword">return</span> self.api
              .put(<span class="hljs-string">'/users/'</span> + self.user1._id)
              .set(<span class="hljs-string">'Authorization'</span>, self.user1.token)
              .send({
                <span class="hljs-attr">lastName</span>: <span class="hljs-string">"toto"</span>,
                <span class="hljs-attr">firstName</span>: <span class="hljs-string">"tata"</span>,
                <span class="hljs-attr">email</span>: <span class="hljs-string">"toto@tata.com"</span>
              })
          })
          .then(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
            expect(res.status).to.eql(<span class="hljs-number">200</span>);
            expect(res.body.response.email).to.eql(<span class="hljs-string">"toto@tata.com"</span>);
            expect(res.body.response.firstName).to.eql(<span class="hljs-string">"tata"</span>);
            expect(res.body.response.lastName).to.eql(<span class="hljs-string">"toto"</span>);
          })
          .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
            <span class="hljs-keyword">throw</span> (err.response) ? <span class="hljs-built_in">Error</span>(err.response.body.Error) : err;
          })
      });

      it(<span class="hljs-string">"should error if token is not present"</span>, () =&gt; {
        <span class="hljs-keyword">let</span> self = <span class="hljs-keyword">this</span>;
        <span class="hljs-keyword">return</span> self.api
          .put(<span class="hljs-string">'/users/'</span> + self.user1._id)
          .send({
            <span class="hljs-attr">password</span>: <span class="hljs-string">"Azerty123"</span>
          })
          .then(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
            expect(res).to.be.a(<span class="hljs-string">'null'</span>);
          })
          .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
            expect(err.status).to.eql(<span class="hljs-number">403</span>);
          })
      });

      it(<span class="hljs-string">"should error if params haven't good format -- see dto in constants for details"</span>, () =&gt; {
        <span class="hljs-keyword">let</span> self = <span class="hljs-keyword">this</span>;
        <span class="hljs-keyword">return</span> self.api
          .put(<span class="hljs-string">'/users/'</span> + self.user1._id)
          .set(<span class="hljs-string">'Authorization'</span>, self.user1.token)
          .send({<span class="hljs-attr">firstName</span>: <span class="hljs-number">1</span>})
          .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
            expect(err.status).to.eql(<span class="hljs-number">500</span>);
            <span class="hljs-keyword">return</span> self.api.put(<span class="hljs-string">'/users/'</span> + self.user1._id)
              .set(<span class="hljs-string">'Authorization'</span>, self.user1.token)
              .send({
                <span class="hljs-attr">email</span>: <span class="hljs-string">"test1.com"</span>
              })
          })
          .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
            expect(err.status).to.eql(<span class="hljs-number">500</span>);
            <span class="hljs-keyword">return</span> self.api.put(<span class="hljs-string">'/users/'</span> + self.user1._id)
              .set(<span class="hljs-string">'Authorization'</span>, self.user1.token)
              .send({
                <span class="hljs-attr">lastName</span>: <span class="hljs-number">2</span>
              })
          })
          .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
            expect(err.status).to.eql(<span class="hljs-number">500</span>);
            <span class="hljs-keyword">return</span> self.api.put(<span class="hljs-string">'/users/'</span> + self.user1._id)
              .set(<span class="hljs-string">'Authorization'</span>, self.user1.token)
              .send({
                <span class="hljs-attr">password</span>: <span class="hljs-string">"12222"</span>
              })
          })
          .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
            expect(err.status).to.eql(<span class="hljs-number">500</span>);
            <span class="hljs-keyword">return</span> self.api.put(<span class="hljs-string">'/users/'</span> + self.user1._id)
              .set(<span class="hljs-string">'Authorization'</span>, self.user1.token)
              .send({
                <span class="hljs-attr">password</span>: <span class="hljs-number">12</span>
              })
          })
          .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
            expect(err.status).to.eql(<span class="hljs-number">500</span>);
          })
      });
    });

    describe(<span class="hljs-string">'/:id -- GET tests'</span>, () =&gt; {
      before(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
        <span class="hljs-keyword">let</span> self = <span class="hljs-keyword">this</span>;
        self.user1 = {
          <span class="hljs-attr">firstName</span>: <span class="hljs-string">"test1"</span>,
          <span class="hljs-attr">lastName</span>: <span class="hljs-string">"test1"</span>,
          <span class="hljs-attr">email</span>: <span class="hljs-string">"test1@test.com"</span>,
          <span class="hljs-attr">password</span>: <span class="hljs-string">"Testtest1"</span>
        };
        self.user2 = {
          <span class="hljs-attr">firstName</span>: <span class="hljs-string">"test2"</span>,
          <span class="hljs-attr">lastName</span>: <span class="hljs-string">"test2"</span>,
          <span class="hljs-attr">email</span>: <span class="hljs-string">"test2@test.com"</span>,
          <span class="hljs-attr">password</span>: <span class="hljs-string">"Testtest2"</span>
        };

        <span class="hljs-keyword">return</span> <span class="hljs-built_in">Promise</span>.all([
          models.Pizza.remove({}),
          models.User.remove({}),
          models.Ingredient.remove({})
        ])
          .then(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
            <span class="hljs-keyword">return</span> models.User.create(self.user1)
          })
          .then(<span class="hljs-function">(<span class="hljs-params">user</span>) =&gt;</span> {
            self.user1._id = user._id;
          })
          .then(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
            <span class="hljs-keyword">return</span> models.User.create(self.user2)
          })
          .then(<span class="hljs-function">(<span class="hljs-params">user</span>) =&gt;</span> {
            self.user2._id = user._id;
          })
          .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
            <span class="hljs-keyword">throw</span> (err.response) ? <span class="hljs-built_in">Error</span>(err.response.body.Error) : err;
          })
      });

      it(<span class="hljs-string">"should return one specific users"</span>, () =&gt; {
        <span class="hljs-keyword">let</span> self = <span class="hljs-keyword">this</span>;
        <span class="hljs-keyword">return</span> self.api
          .get(<span class="hljs-string">'/users/'</span> + self.user1._id)
          .then(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
            expect(res.statusCode).to.eql(<span class="hljs-number">200</span>);
            expect(res.body.response.email).to.eql(self.user1.email);
            expect(res.body.response.lastName).to.eql(self.user1.lastName);
            expect(res.body.response.firstName).to.eql(self.user1.firstName);
          })
          .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
            <span class="hljs-keyword">throw</span> (err.response) ? <span class="hljs-built_in">Error</span>(err.response.body.Error) : err;
          })
      });

      it(<span class="hljs-string">"should return one specific users and different of second user"</span>, () =&gt; {
        <span class="hljs-keyword">let</span> self = <span class="hljs-keyword">this</span>;
        <span class="hljs-keyword">return</span> self.api
          .get(<span class="hljs-string">'/users/'</span> + self.user2._id)
          .then(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
            expect(res.statusCode).to.eql(<span class="hljs-number">200</span>);
            expect(res.body.response.email).to.not.eql(self.user1.email);
            expect(res.body.response.lastName).to.not.eql(self.user1.lastName);
            expect(res.body.response.firstName).to.not.eql(self.user1.firstName);
          })
          .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
            <span class="hljs-keyword">throw</span> (err.response) ? <span class="hljs-built_in">Error</span>(err.response.body.Error) : err;
          })
      });

      it(<span class="hljs-string">"should error if id param doesn't have corresponding documents in mongoDB"</span>, () =&gt; {
        <span class="hljs-keyword">let</span> self = <span class="hljs-keyword">this</span>;
        <span class="hljs-keyword">return</span> self.api
          .get(<span class="hljs-string">'/users/'</span> + self.user2._id + <span class="hljs-number">1</span>)
          .then(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
            expect(res).to.be.a(<span class="hljs-string">'null'</span>);
          })
          .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
            expect(err.response.status).to.eql(<span class="hljs-number">404</span>);
          })
      });
    });

    describe(<span class="hljs-string">'/:id -- DELETE tests'</span>, () =&gt; {
      before(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
        <span class="hljs-keyword">let</span> self = <span class="hljs-keyword">this</span>;
        self.user1 = {
          <span class="hljs-attr">firstName</span>: <span class="hljs-string">"test1"</span>,
          <span class="hljs-attr">lastName</span>: <span class="hljs-string">"test1"</span>,
          <span class="hljs-attr">email</span>: <span class="hljs-string">"test1@test.com"</span>,
          <span class="hljs-attr">password</span>: <span class="hljs-string">"Testtest1"</span>
        };

        <span class="hljs-keyword">return</span> <span class="hljs-built_in">Promise</span>.all([
          models.Pizza.remove({}),
          models.User.remove({}),
          models.Ingredient.remove({})
        ])
          .then(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
            <span class="hljs-keyword">return</span> models.User.specials.signup(self.user1)
          })
          .then(<span class="hljs-function">(<span class="hljs-params">user</span>) =&gt;</span> {
            <span class="hljs-keyword">return</span> self.api.post(<span class="hljs-string">'/users/signin'</span>)
              .send({
                <span class="hljs-attr">email</span>: self.user1.email,
                <span class="hljs-attr">password</span>: self.user1.password
              })
          })
          .then(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
            self.user1.token = res.body.response;
            <span class="hljs-keyword">return</span> tools.verifyJWTAsync(res.body.response);
          })
          .then(<span class="hljs-function">(<span class="hljs-params">decoded</span>) =&gt;</span> {
            self.user1._id = decoded.id;
          })
          .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
            <span class="hljs-keyword">throw</span> (err.response) ? <span class="hljs-built_in">Error</span>(err.response.body.Error) : err;
          })
      });

      it(<span class="hljs-string">"should remove one specific users"</span>, () =&gt; {
        <span class="hljs-keyword">let</span> self = <span class="hljs-keyword">this</span>;
        <span class="hljs-keyword">return</span> self.api
          .del(<span class="hljs-string">'/users/'</span> + self.user1._id)
          .set(<span class="hljs-string">'Authorization'</span>, self.user1.token)
          .then(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
            expect(res.statusCode).to.eql(<span class="hljs-number">200</span>);
            expect(res.body.response).to.eql(<span class="hljs-literal">true</span>);
          })
          .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
            <span class="hljs-keyword">throw</span> (err.response) ? <span class="hljs-built_in">Error</span>(err.response.body.Error) : err;
          })
      });

      it(<span class="hljs-string">"should error if id param doesn't have corresponding documents in mongoDB"</span>, () =&gt; {
        <span class="hljs-keyword">let</span> self = <span class="hljs-keyword">this</span>;
        <span class="hljs-keyword">return</span> self.api
          .del(<span class="hljs-string">'/users/'</span> + self.user1._id + <span class="hljs-number">1</span>)
          .set(<span class="hljs-string">'Authorization'</span>, self.user1.token)
          .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
            expect(err.status).to.eql(<span class="hljs-number">500</span>);
          })
      });

      it(<span class="hljs-string">"should error if token is not present"</span>, () =&gt; {
        <span class="hljs-keyword">let</span> self = <span class="hljs-keyword">this</span>;
        <span class="hljs-keyword">return</span> self.api
          .del(<span class="hljs-string">'/users/'</span> + self.user1._id)
          .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
            expect(err.status).to.eql(<span class="hljs-number">403</span>);
            expect(err.response.body).to.eql({<span class="hljs-string">"error"</span>: <span class="hljs-string">"Token missing"</span>});
          })
      });
    });
  });

});

describe(<span class="hljs-string">'/ingredients'</span>, () =&gt; {
  before(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">Promise</span>.all([
      models.Pizza.remove({}),
      models.User.remove({}),
      models.Ingredient.remove({})
    ])
      .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
        <span class="hljs-keyword">throw</span> (err.response) ? <span class="hljs-built_in">Error</span>(err.response.body.Error) : err;
      })
  });

  describe(<span class="hljs-string">'/ -- GET tests'</span>, () =&gt; {
    before(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
      <span class="hljs-keyword">let</span> self = <span class="hljs-keyword">this</span>;
      self.ingredient1 = {
        <span class="hljs-attr">name</span>: <span class="hljs-string">"ingredient1"</span>,
        <span class="hljs-attr">weight</span>: <span class="hljs-number">200</span>,
        <span class="hljs-attr">priceCts</span>: <span class="hljs-number">200</span>
      };
      self.ingredient2 = {
        <span class="hljs-attr">name</span>: <span class="hljs-string">"ingredient2"</span>,
        <span class="hljs-attr">weight</span>: <span class="hljs-number">150</span>,
        <span class="hljs-attr">priceCts</span>: <span class="hljs-number">150</span>
      };

      <span class="hljs-keyword">return</span> <span class="hljs-built_in">Promise</span>.all([
        models.Pizza.remove({}),
        models.User.remove({}),
        models.Ingredient.remove({})
      ])
        .then(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
          <span class="hljs-keyword">return</span> models.Ingredient.create(self.ingredient1);
        })
        .then(<span class="hljs-function">(<span class="hljs-params">ingredient</span>) =&gt;</span> {
          <span class="hljs-keyword">return</span> models.Ingredient.create(self.ingredient2);
        })
        .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
          <span class="hljs-keyword">throw</span> (err.response) ? <span class="hljs-built_in">Error</span>(err.response.body.Error) : err;
        })
    });

    it(<span class="hljs-string">"should return two ingredients"</span>, () =&gt; {
      <span class="hljs-keyword">let</span> self = <span class="hljs-keyword">this</span>;
      <span class="hljs-keyword">return</span> self.api
        .get(<span class="hljs-string">'/ingredients'</span>)
        .then(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
          expect(res.statusCode).to.eql(<span class="hljs-number">200</span>);
          expect(res.body.response.length).to.eql(<span class="hljs-number">2</span>);
          res.body.response.forEach(<span class="hljs-function">(<span class="hljs-params">ingredient, index</span>) =&gt;</span> {
            index++;
            expect(ingredient.name).to.eql(self[<span class="hljs-string">"ingredient"</span> + index].name);
            expect(ingredient.weight).to.eql(self[<span class="hljs-string">"ingredient"</span> + index].weight);
            expect(ingredient.priceCts).to.eql(self[<span class="hljs-string">"ingredient"</span> + index].priceCts);
          })
        })
        .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
          <span class="hljs-keyword">throw</span> (err.response) ? <span class="hljs-built_in">Error</span>(err.response.body.Error) : err;
        })
    });

    it(<span class="hljs-string">"should return empty array if no ingredients"</span>, () =&gt; {
      <span class="hljs-keyword">let</span> self = <span class="hljs-keyword">this</span>;
      <span class="hljs-keyword">return</span> models.Ingredient.remove({})
        .then(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
          <span class="hljs-keyword">return</span> self.api
            .get(<span class="hljs-string">'/ingredients'</span>)
        })
        .then(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
          expect(res.statusCode).to.eql(<span class="hljs-number">200</span>);
          expect(res.body.response.length).to.eql(<span class="hljs-number">0</span>);
        })
        .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
          <span class="hljs-keyword">throw</span> (err.response) ? <span class="hljs-built_in">Error</span>(err.response.body.Error) : err;
        })
    });

  });

  describe(<span class="hljs-string">'/ -- POST tests'</span>, () =&gt; {
    before(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
      <span class="hljs-keyword">let</span> self = <span class="hljs-keyword">this</span>;
      self.user1 = {
        <span class="hljs-attr">firstName</span>: <span class="hljs-string">"test1"</span>,
        <span class="hljs-attr">lastName</span>: <span class="hljs-string">"test1"</span>,
        <span class="hljs-attr">email</span>: <span class="hljs-string">"test1@test.com"</span>,
        <span class="hljs-attr">password</span>: <span class="hljs-string">"Testtest1"</span>
      };
      self.ingredient1 = {
        <span class="hljs-attr">name</span>: <span class="hljs-string">"ingredient1"</span>,
        <span class="hljs-attr">weight</span>: <span class="hljs-number">150</span>,
        <span class="hljs-attr">priceCts</span>: <span class="hljs-number">150</span>
      };
      self.ingredient2 = {
        <span class="hljs-attr">name</span>: <span class="hljs-string">"ingredient2"</span>,
        <span class="hljs-attr">weight</span>: <span class="hljs-number">180</span>,
        <span class="hljs-attr">priceCts</span>: <span class="hljs-number">180</span>
      };

      <span class="hljs-keyword">return</span> <span class="hljs-built_in">Promise</span>.all([
        models.Pizza.remove({}),
        models.User.remove({}),
        models.Ingredient.remove({})
      ])

        .then(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
          <span class="hljs-keyword">return</span> models.User.specials.signup(self.user1)
        })
        .then(<span class="hljs-function">(<span class="hljs-params">token</span>) =&gt;</span> {
          <span class="hljs-keyword">return</span> tools.verifyJWTAsync(token);
        })
        .then(<span class="hljs-function">(<span class="hljs-params">decoded</span>) =&gt;</span> {
          self.user1._id = decoded.id;
          <span class="hljs-keyword">return</span> self.api.post(<span class="hljs-string">'/users/signin'</span>)
            .send({
              <span class="hljs-attr">email</span>: self.user1.email,
              <span class="hljs-attr">password</span>: self.user1.password
            })
        })
        .then(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
          self.user1.token = res.body.response;
        })
        .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
          <span class="hljs-keyword">throw</span> (err.response) ? <span class="hljs-built_in">Error</span>(err.response.body.Error) : err;
        })
    });

    it(<span class="hljs-string">"should create one ingredient and return ingredient created"</span>, () =&gt; {
      <span class="hljs-keyword">let</span> self = <span class="hljs-keyword">this</span>;
      <span class="hljs-keyword">return</span> self.api
        .post(<span class="hljs-string">'/ingredients/add'</span>)
        .send(self.ingredient1)
        .set(<span class="hljs-string">'Authorization'</span>, self.user1.token)
        .then(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
          <span class="hljs-keyword">let</span> ingredient = res.body.response;
          expect(res.statusCode).to.eql(<span class="hljs-number">200</span>);
          expect(ingredient.name).to.eql(self.ingredient1.name);
          expect(ingredient.weight).to.eql(self.ingredient1.weight);
          expect(ingredient.priceCts).to.eql(self.ingredient1.priceCts);
        })
        .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
          <span class="hljs-keyword">throw</span> (err.response) ? <span class="hljs-built_in">Error</span>(err.response.body.Error) : err;
        })
    });

    it(<span class="hljs-string">"should error if required params are not present"</span>, () =&gt; {
      <span class="hljs-keyword">let</span> self = <span class="hljs-keyword">this</span>;
      <span class="hljs-keyword">return</span> self.api
        .post(<span class="hljs-string">'/ingredients/add'</span>)
        .set(<span class="hljs-string">'Authorization'</span>, self.user1.token)
        .send({})
        .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
          expect(err.status).to.eql(<span class="hljs-number">500</span>);
          <span class="hljs-keyword">return</span> self.api.post(<span class="hljs-string">'/ingredients/add'</span>)
            .set(<span class="hljs-string">'Authorization'</span>, self.user1.token)
            .send({
              <span class="hljs-attr">name</span>: self.ingredient1.name
            })
        })
        .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
          expect(err.status).to.eql(<span class="hljs-number">500</span>);
          <span class="hljs-keyword">return</span> self.api.post(<span class="hljs-string">'/ingredients/add'</span>)
            .set(<span class="hljs-string">'Authorization'</span>, self.user1.token)
            .send({
              <span class="hljs-attr">weight</span>: self.ingredient1.weight,
              <span class="hljs-attr">priceCts</span>: self.ingredient1.priceCts
            })
        })
        .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
          expect(err.status).to.eql(<span class="hljs-number">500</span>);
        })
    });

    it(<span class="hljs-string">"should error if params haven't good format -- see dto in constants for details"</span>, () =&gt; {
      <span class="hljs-keyword">let</span> self = <span class="hljs-keyword">this</span>;
      <span class="hljs-keyword">return</span> self.api
        .post(<span class="hljs-string">'/ingredients/add'</span>)
        .set(<span class="hljs-string">'Authorization'</span>, self.user1.token)
        .send({})
        .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
          expect(err.status).to.eql(<span class="hljs-number">500</span>);
          <span class="hljs-keyword">return</span> self.api.post(<span class="hljs-string">'/ingredients/add'</span>)
            .set(<span class="hljs-string">'Authorization'</span>, self.user1.token)
            .send({
              <span class="hljs-attr">name</span>: <span class="hljs-number">1</span>
            })
        })
        .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
          expect(err.status).to.eql(<span class="hljs-number">500</span>);
          <span class="hljs-keyword">return</span> self.api.post(<span class="hljs-string">'/ingredients/add'</span>)
            .set(<span class="hljs-string">'Authorization'</span>, self.user1.token)
            .send({
              <span class="hljs-attr">priceCts</span>: <span class="hljs-string">"tete"</span>
            })
        })
        .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
          expect(err.status).to.eql(<span class="hljs-number">500</span>);
          <span class="hljs-keyword">return</span> self.api.post(<span class="hljs-string">'/ingredients/add'</span>)
            .set(<span class="hljs-string">'Authorization'</span>, self.user1.token)
            .send({
              <span class="hljs-attr">weight</span>: <span class="hljs-string">"tete"</span>
            })
        })
        .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
          expect(err.status).to.eql(<span class="hljs-number">500</span>);
        })
    });
  });

  describe(<span class="hljs-string">'/:id -- PUT tests'</span>, () =&gt; {
    before(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
      <span class="hljs-keyword">let</span> self = <span class="hljs-keyword">this</span>;
      self.user1 = {
        <span class="hljs-attr">firstName</span>: <span class="hljs-string">"test1"</span>,
        <span class="hljs-attr">lastName</span>: <span class="hljs-string">"test1"</span>,
        <span class="hljs-attr">email</span>: <span class="hljs-string">"test1@test.com"</span>,
        <span class="hljs-attr">password</span>: <span class="hljs-string">"Testtest1"</span>
      };
      self.ingredient1 = {
        <span class="hljs-attr">name</span>: <span class="hljs-string">"ingredient1"</span>,
        <span class="hljs-attr">weight</span>: <span class="hljs-number">200</span>,
        <span class="hljs-attr">priceCts</span>: <span class="hljs-number">200</span>
      };
      self.ingredient2 = {
        <span class="hljs-attr">name</span>: <span class="hljs-string">"ingredient2"</span>,
        <span class="hljs-attr">weight</span>: <span class="hljs-number">150</span>,
        <span class="hljs-attr">priceCts</span>: <span class="hljs-number">150</span>
      };

      <span class="hljs-keyword">return</span> <span class="hljs-built_in">Promise</span>.all([
        models.Pizza.remove({}),
        models.User.remove({}),
        models.Ingredient.remove({})
      ])
        .then(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
          <span class="hljs-keyword">return</span> models.User.specials.signup(self.user1)
        })
        .then(<span class="hljs-function">(<span class="hljs-params">user</span>) =&gt;</span> {
          self.user1._id = user._id;
          <span class="hljs-keyword">return</span> models.Ingredient.create(self.ingredient1);
        })
        .then(<span class="hljs-function">(<span class="hljs-params">ingredient</span>) =&gt;</span> {
          self.ingredient1._id = ingredient._id;
          <span class="hljs-keyword">return</span> models.Ingredient.create(self.ingredient2);
        })
        .then(<span class="hljs-function">(<span class="hljs-params">ingredient</span>) =&gt;</span> {
          self.ingredient2._id = ingredient._id;
          <span class="hljs-keyword">return</span> self.api.post(<span class="hljs-string">'/users/signin'</span>)
            .send({
              <span class="hljs-attr">email</span>: self.user1.email,
              <span class="hljs-attr">password</span>: self.user1.password
            })
        })
        .then(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
          self.user1.token = res.body.response;
        })
        .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
          <span class="hljs-keyword">throw</span> (err.response) ? <span class="hljs-built_in">Error</span>(err.response.body.Error) : err;
        })
    });

    it(<span class="hljs-string">"should modify user who is passed in param and return user updated"</span>, () =&gt; {
      <span class="hljs-keyword">let</span> self = <span class="hljs-keyword">this</span>;
      <span class="hljs-keyword">return</span> self.api
        .put(<span class="hljs-string">'/ingredients/'</span> + self.ingredient1._id)
        .send({
          <span class="hljs-attr">name</span>: self.ingredient1.name + <span class="hljs-string">" test"</span>,
          <span class="hljs-attr">weight</span>: self.ingredient1.weight + <span class="hljs-number">1</span>,
          <span class="hljs-attr">priceCts</span>: self.ingredient1.priceCts + <span class="hljs-number">1</span>
        })
        .set(<span class="hljs-string">'Authorization'</span>, self.user1.token)
        .then(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
          expect(res.status).to.eql(<span class="hljs-number">200</span>);
          expect(res.body.response.name).to.eql(self.ingredient1.name + <span class="hljs-string">" test"</span>);
          expect(res.body.response.weight).to.eql(self.ingredient1.weight + <span class="hljs-number">1</span>);
          expect(res.body.response.priceCts).to.eql(self.ingredient1.priceCts + <span class="hljs-number">1</span>);
        })
        .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
          <span class="hljs-keyword">throw</span> (err.response) ? <span class="hljs-built_in">Error</span>(err.response.body.Error) : err;
        })
    });

    it(<span class="hljs-string">"should error if token is not present"</span>, () =&gt; {
      <span class="hljs-keyword">let</span> self = <span class="hljs-keyword">this</span>;
      <span class="hljs-keyword">return</span> self.api
        .put(<span class="hljs-string">'/ingredients/'</span> + self.ingredient1._id)
        .send({
          <span class="hljs-attr">name</span>: self.ingredient1.name + <span class="hljs-string">" test"</span>,
          <span class="hljs-attr">weight</span>: self.ingredient1.weight + <span class="hljs-number">1</span>,
          <span class="hljs-attr">priceCts</span>: self.ingredient1.priceCts + <span class="hljs-number">1</span>
        })
        .then(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
          expect(res).to.be.a(<span class="hljs-string">'null'</span>);
        })
        .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
          expect(err.status).to.eql(<span class="hljs-number">403</span>);
        })
    });

    it(<span class="hljs-string">"should error if params haven't good format -- see dto in constants for details"</span>, () =&gt; {
      <span class="hljs-keyword">let</span> self = <span class="hljs-keyword">this</span>;
      <span class="hljs-keyword">return</span> self.api
        .put(<span class="hljs-string">'/ingredients/'</span> + self.ingredient1._id)
        .set(<span class="hljs-string">'Authorization'</span>, self.user1.token)
        .send({<span class="hljs-attr">name</span>: <span class="hljs-number">1</span>})
        .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
          expect(err.status).to.eql(<span class="hljs-number">500</span>);
          <span class="hljs-keyword">return</span> self.api.put(<span class="hljs-string">'/ingredients/'</span> + self.ingredient1._id)
            .set(<span class="hljs-string">'Authorization'</span>, self.user1.token)
            .send({
              <span class="hljs-attr">priceCts</span>: <span class="hljs-string">"tete"</span>
            })
        })
        .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
          expect(err.status).to.eql(<span class="hljs-number">500</span>);
          <span class="hljs-keyword">return</span> self.api.put(<span class="hljs-string">'/ingredients/'</span> + self.ingredient1._id)
            .set(<span class="hljs-string">'Authorization'</span>, self.user1.token)
            .send({
              <span class="hljs-attr">weight</span>: <span class="hljs-string">"tete"</span>
            })
        })
        .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
          expect(err.status).to.eql(<span class="hljs-number">500</span>);
        })
    });
  });

  describe(<span class="hljs-string">'/:id -- GET tests'</span>, () =&gt; {
    before(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
      <span class="hljs-keyword">let</span> self = <span class="hljs-keyword">this</span>;
      self.ingredient1 = {
        <span class="hljs-attr">name</span>: <span class="hljs-string">"ingredient1"</span>,
        <span class="hljs-attr">weight</span>: <span class="hljs-number">200</span>,
        <span class="hljs-attr">priceCts</span>: <span class="hljs-number">200</span>
      };
      self.ingredient2 = {
        <span class="hljs-attr">name</span>: <span class="hljs-string">"ingredient2"</span>,
        <span class="hljs-attr">weight</span>: <span class="hljs-number">150</span>,
        <span class="hljs-attr">priceCts</span>: <span class="hljs-number">150</span>
      };

      <span class="hljs-keyword">return</span> <span class="hljs-built_in">Promise</span>.all([
        models.Pizza.remove({}),
        models.User.remove({}),
        models.Ingredient.remove({})
      ])
        .then(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
          <span class="hljs-keyword">return</span> models.Ingredient.create(self.ingredient1);
        })
        .then(<span class="hljs-function">(<span class="hljs-params">ingredient</span>) =&gt;</span> {
          self.ingredient1._id = ingredient._id;
          <span class="hljs-keyword">return</span> models.Ingredient.create(self.ingredient2);
        })
        .then(<span class="hljs-function">(<span class="hljs-params">ingredient</span>) =&gt;</span> {
          self.ingredient2._id = ingredient._id;
        })
        .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
          <span class="hljs-keyword">throw</span> (err.response) ? <span class="hljs-built_in">Error</span>(err.response.body.Error) : err;
        })
    });

    it(<span class="hljs-string">"should return one specific ingredients"</span>, () =&gt; {
      <span class="hljs-keyword">let</span> self = <span class="hljs-keyword">this</span>;
      <span class="hljs-keyword">return</span> self.api
        .get(<span class="hljs-string">'/ingredients/'</span> + self.ingredient1._id)
        .then(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
          expect(res.statusCode).to.eql(<span class="hljs-number">200</span>);
          expect(res.body.response.name).to.eql(self.ingredient1.name);
          expect(res.body.response.weight).to.eql(self.ingredient1.weight);
          expect(res.body.response.priceCts).to.eql(self.ingredient1.priceCts);
        })
        .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
          <span class="hljs-keyword">throw</span> (err.response) ? <span class="hljs-built_in">Error</span>(err.response.body.Error) : err;
        })
    });

    it(<span class="hljs-string">"should return one specific ingredients and different of second ingredients"</span>, () =&gt; {
      <span class="hljs-keyword">let</span> self = <span class="hljs-keyword">this</span>;
      <span class="hljs-keyword">return</span> self.api
        .get(<span class="hljs-string">'/ingredients/'</span> + self.ingredient2._id)
        .then(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
          expect(res.statusCode).to.eql(<span class="hljs-number">200</span>);
          expect(res.body.response.name).to.not.eql(self.ingredient1.name);
          expect(res.body.response.weight).to.not.eql(self.ingredient1.weight);
          expect(res.body.response.priceCts).to.not.eql(self.ingredient1.priceCts);
        })
        .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
          <span class="hljs-keyword">throw</span> (err.response) ? <span class="hljs-built_in">Error</span>(err.response.body.Error) : err;
        })
    });

    it(<span class="hljs-string">"should error if id param doesn't have corresponding documents in mongoDB"</span>, () =&gt; {
      <span class="hljs-keyword">let</span> self = <span class="hljs-keyword">this</span>;
      <span class="hljs-keyword">return</span> self.api
        .get(<span class="hljs-string">'/ingredients/'</span> + self.ingredient1._id + <span class="hljs-number">1</span>)
        .then(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
          expect(res).to.be.a(<span class="hljs-string">'null'</span>);
        })
        .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
          expect(err.response.status).to.eql(<span class="hljs-number">404</span>);
        })
    });

  });

  describe(<span class="hljs-string">'/:id -- DELETE tests'</span>, () =&gt; {
    before(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
      <span class="hljs-keyword">let</span> self = <span class="hljs-keyword">this</span>;
      self.user1 = {
        <span class="hljs-attr">firstName</span>: <span class="hljs-string">"test1"</span>,
        <span class="hljs-attr">lastName</span>: <span class="hljs-string">"test1"</span>,
        <span class="hljs-attr">email</span>: <span class="hljs-string">"test1@test.com"</span>,
        <span class="hljs-attr">password</span>: <span class="hljs-string">"Testtest1"</span>
      };
      self.ingredient1 = {
        <span class="hljs-attr">name</span>: <span class="hljs-string">"ingredient1"</span>,
        <span class="hljs-attr">weight</span>: <span class="hljs-number">200</span>,
        <span class="hljs-attr">priceCts</span>: <span class="hljs-number">200</span>
      };
      self.ingredient2 = {
        <span class="hljs-attr">name</span>: <span class="hljs-string">"ingredient2"</span>,
        <span class="hljs-attr">weight</span>: <span class="hljs-number">150</span>,
        <span class="hljs-attr">priceCts</span>: <span class="hljs-number">150</span>
      };

      <span class="hljs-keyword">return</span> <span class="hljs-built_in">Promise</span>.all([
        models.Pizza.remove({}),
        models.User.remove({}),
        models.Ingredient.remove({})
      ])
        .then(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
          <span class="hljs-keyword">return</span> models.User.specials.signup(self.user1)
        })
        .then(<span class="hljs-function">(<span class="hljs-params">user</span>) =&gt;</span> {
          self.user1._id = user._id;
          <span class="hljs-keyword">return</span> models.Ingredient.create(self.ingredient1);
        })
        .then(<span class="hljs-function">(<span class="hljs-params">ingredient</span>) =&gt;</span> {
          self.ingredient1._id = ingredient._id;
          <span class="hljs-keyword">return</span> models.Ingredient.create(self.ingredient2);
        })
        .then(<span class="hljs-function">(<span class="hljs-params">ingredient</span>) =&gt;</span> {
          self.ingredient2._id = ingredient._id;
          <span class="hljs-keyword">return</span> self.api.post(<span class="hljs-string">'/users/signin'</span>)
            .send({
              <span class="hljs-attr">email</span>: self.user1.email,
              <span class="hljs-attr">password</span>: self.user1.password
            })
        })
        .then(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
          self.user1.token = res.body.response;
        })
        .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
          <span class="hljs-keyword">throw</span> (err.response) ? <span class="hljs-built_in">Error</span>(err.response.body.Error) : err;
        })
    });

    it(<span class="hljs-string">"should remove one specific ingredient"</span>, () =&gt; {
      <span class="hljs-keyword">let</span> self = <span class="hljs-keyword">this</span>;
      <span class="hljs-keyword">return</span> self.api
        .del(<span class="hljs-string">'/ingredients/'</span> + self.ingredient1._id)
        .set(<span class="hljs-string">'Authorization'</span>, self.user1.token)
        .then(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
          expect(res.statusCode).to.eql(<span class="hljs-number">200</span>);
          expect(res.body.response).to.eql(<span class="hljs-literal">true</span>);
        })
        .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
          <span class="hljs-keyword">throw</span> (err.response) ? <span class="hljs-built_in">Error</span>(err.response.body.Error) : err;
        })
    });

    it(<span class="hljs-string">"should error if id param doesn't have corresponding documents in mongoDB"</span>, () =&gt; {
      <span class="hljs-keyword">let</span> self = <span class="hljs-keyword">this</span>;
      <span class="hljs-keyword">return</span> self.api
        .del(<span class="hljs-string">'/ingredients/'</span> + self.ingredient1._id + <span class="hljs-number">1</span>)
        .set(<span class="hljs-string">'Authorization'</span>, self.user1.token)
        .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
          expect(err.status).to.eql(<span class="hljs-number">500</span>);
        })
    });

    it(<span class="hljs-string">"should error if token is not present"</span>, () =&gt; {
      <span class="hljs-keyword">let</span> self = <span class="hljs-keyword">this</span>;
      <span class="hljs-keyword">return</span> self.api
        .del(<span class="hljs-string">'/ingredients/'</span> + self.ingredient1._id)
        .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
          expect(err.status).to.eql(<span class="hljs-number">403</span>);
          expect(err.response.body).to.eql({<span class="hljs-string">"error"</span>: <span class="hljs-string">"Token missing"</span>});
        })
    });
  });

});

describe(<span class="hljs-string">'/pizzas'</span>, () =&gt; {
  before(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">Promise</span>.all([
      models.Pizza.remove({}),
      models.User.remove({}),
      models.Ingredient.remove({})
    ])
      .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
        <span class="hljs-keyword">throw</span> (err.response) ? <span class="hljs-built_in">Error</span>(err.response.body.Error) : err;
      })
  });

  describe(<span class="hljs-string">'/ -- GET tests'</span>, () =&gt; {
    before(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
      <span class="hljs-keyword">let</span> self = <span class="hljs-keyword">this</span>;
      self.user1 = {
        <span class="hljs-attr">firstName</span>: <span class="hljs-string">"test1"</span>,
        <span class="hljs-attr">lastName</span>: <span class="hljs-string">"test1"</span>,
        <span class="hljs-attr">email</span>: <span class="hljs-string">"test1@test.com"</span>,
        <span class="hljs-attr">password</span>: <span class="hljs-string">"Testtest1"</span>
      };
      self.pizza1 = {
        <span class="hljs-attr">name</span>: <span class="hljs-string">"pizza1"</span>,
        <span class="hljs-attr">image</span>: <span class="hljs-string">""</span>,
        <span class="hljs-attr">ingredients</span>: [],
        <span class="hljs-attr">description</span>: <span class="hljs-string">"lorem ipsum"</span>,
        <span class="hljs-attr">priceCts</span>: <span class="hljs-number">200</span>
      };
      self.pizza2 = {
        <span class="hljs-attr">name</span>: <span class="hljs-string">"pizza2"</span>,
        <span class="hljs-attr">image</span>: <span class="hljs-string">""</span>,
        <span class="hljs-attr">ingredients</span>: [],
        <span class="hljs-attr">description</span>: <span class="hljs-string">"lorem ipsum"</span>,
        <span class="hljs-attr">priceCts</span>: <span class="hljs-number">150</span>
      };

      <span class="hljs-keyword">return</span> <span class="hljs-built_in">Promise</span>.all([
        models.Pizza.remove({}),
        models.User.remove({}),
        models.Ingredient.remove({})
      ])
        .then(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
          <span class="hljs-keyword">return</span> models.User.create(self.user1)
        })
        .then(<span class="hljs-function">(<span class="hljs-params">user</span>) =&gt;</span> {
          self.user1._id = user._id;
          self.pizza1.cook = self.user1._id;
          <span class="hljs-keyword">return</span> models.Pizza.create(self.pizza1);
        })
        .then(<span class="hljs-function">(<span class="hljs-params">ingredient</span>) =&gt;</span> {
          self.pizza2.cook = self.user1._id;
          <span class="hljs-keyword">return</span> models.Pizza.create(self.pizza2);
        })
        .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
          <span class="hljs-keyword">throw</span> (err.response) ? <span class="hljs-built_in">Error</span>(err.response.body.Error) : err;
        })
    });

    it(<span class="hljs-string">"should return two pizzas"</span>, () =&gt; {
      <span class="hljs-keyword">let</span> self = <span class="hljs-keyword">this</span>;
      <span class="hljs-keyword">return</span> self.api
        .get(<span class="hljs-string">'/pizzas'</span>)
        .then(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
          expect(res.statusCode).to.eql(<span class="hljs-number">200</span>);
          expect(res.body.response.length).to.eql(<span class="hljs-number">2</span>);
          res.body.response.forEach(<span class="hljs-function">(<span class="hljs-params">pizza, index</span>) =&gt;</span> {
            index++;
            expect(pizza.name).to.eql(self[<span class="hljs-string">"pizza"</span> + index].name);
            expect(pizza.cook._id.toString()).to.eql(self[<span class="hljs-string">"pizza"</span> + index].cook.toString());
            expect(pizza.description).to.eql(self[<span class="hljs-string">"pizza"</span> + index].description);
            expect(pizza.priceCts).to.eql(self[<span class="hljs-string">"pizza"</span> + index].priceCts);
          })
        })
        .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
          <span class="hljs-keyword">throw</span> (err.response) ? <span class="hljs-built_in">Error</span>(err.response.body.Error) : err;
        })
    });

    it(<span class="hljs-string">"should return empty array if no pizzas"</span>, () =&gt; {
      <span class="hljs-keyword">let</span> self = <span class="hljs-keyword">this</span>;
      <span class="hljs-keyword">return</span> models.Pizza.remove({})
        .then(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
          <span class="hljs-keyword">return</span> self.api
            .get(<span class="hljs-string">'/pizzas'</span>)
        })
        .then(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
          expect(res.statusCode).to.eql(<span class="hljs-number">200</span>);
          expect(res.body.response.length).to.eql(<span class="hljs-number">0</span>);
        })
        .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
          <span class="hljs-keyword">throw</span> (err.response) ? <span class="hljs-built_in">Error</span>(err.response.body.Error) : err;
        })
    });
  });

  describe(<span class="hljs-string">'/ -- POST tests'</span>, () =&gt; {
    before(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
      <span class="hljs-keyword">let</span> self = <span class="hljs-keyword">this</span>;
      self.user1 = {
        <span class="hljs-attr">firstName</span>: <span class="hljs-string">"test1"</span>,
        <span class="hljs-attr">lastName</span>: <span class="hljs-string">"test1"</span>,
        <span class="hljs-attr">email</span>: <span class="hljs-string">"test1@test.com"</span>,
        <span class="hljs-attr">password</span>: <span class="hljs-string">"Testtest1"</span>
      };
      self.pizza1 = {
        <span class="hljs-attr">name</span>: <span class="hljs-string">"pizza1"</span>,
        <span class="hljs-attr">image</span>: <span class="hljs-string">"123"</span>,
        <span class="hljs-attr">description</span>: <span class="hljs-string">"lorem ipsum1"</span>,
        <span class="hljs-attr">priceCts</span>: <span class="hljs-number">200</span>
      };
      self.pizza2 = {
        <span class="hljs-attr">name</span>: <span class="hljs-string">"pizza2"</span>,
        <span class="hljs-attr">image</span>: <span class="hljs-string">"123"</span>,
        <span class="hljs-attr">description</span>: <span class="hljs-string">"lorem ipsum2"</span>,
        <span class="hljs-attr">priceCts</span>: <span class="hljs-number">150</span>
      };
      self.ingredient1 = {
        <span class="hljs-attr">name</span>: <span class="hljs-string">"ingredient1"</span>,
        <span class="hljs-attr">weight</span>: <span class="hljs-number">150</span>,
        <span class="hljs-attr">priceCts</span>: <span class="hljs-number">150</span>
      };

      <span class="hljs-keyword">return</span> <span class="hljs-built_in">Promise</span>.all([
        models.Pizza.remove({}),
        models.User.remove({}),
        models.Ingredient.remove({})
      ])

        .then(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
          <span class="hljs-keyword">return</span> models.User.specials.signup(self.user1)
        })
        .then(<span class="hljs-function">(<span class="hljs-params">token</span>) =&gt;</span> {
          <span class="hljs-keyword">return</span> tools.verifyJWTAsync(token);
        })
        .then(<span class="hljs-function">(<span class="hljs-params">decoded</span>) =&gt;</span> {
          self.user1._id = decoded.id;
          self.pizza1.cook = decoded.id;
          <span class="hljs-keyword">return</span> models.Ingredient.create(self.ingredient1);
        })
        .then(<span class="hljs-function">(<span class="hljs-params">ingredient</span>) =&gt;</span> {
          self.pizza1.ingredients = [ingredient._id];
          self.pizza2.ingredients = [ingredient._id];
          self.pizza2.cook = self.user1._id;
          <span class="hljs-keyword">return</span> self.api.post(<span class="hljs-string">'/users/signin'</span>)
            .send({
              <span class="hljs-attr">email</span>: self.user1.email,
              <span class="hljs-attr">password</span>: self.user1.password
            })
        })
        .then(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
          self.user1.token = res.body.response;
        })
        .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
          <span class="hljs-keyword">throw</span> (err.response) ? <span class="hljs-built_in">Error</span>(err.response.body.Error) : err;
        })
    });

    it(<span class="hljs-string">"should create one pizza and return pizza created"</span>, () =&gt; {
      <span class="hljs-keyword">let</span> self = <span class="hljs-keyword">this</span>;
      <span class="hljs-keyword">return</span> self.api
        .post(<span class="hljs-string">'/pizzas/add'</span>)
        .send(self.pizza1)
        .set(<span class="hljs-string">'Authorization'</span>, self.user1.token)
        .then(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
          <span class="hljs-keyword">let</span> pizza = res.body.response;
          expect(res.statusCode).to.eql(<span class="hljs-number">200</span>);
          expect(pizza.name).to.eql(self.pizza1.name);
          expect(<span class="hljs-keyword">new</span> Buffer(pizza.image.data).toString()).to.eql(self.pizza1.image);
          expect(pizza.description).to.eql(self.pizza1.description);
          expect(pizza.ingredients.length).to.eql(self.pizza1.ingredients.length);
          expect(pizza.cook._id.toString()).to.eql(self.pizza1.cook);
        })
        .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
          <span class="hljs-keyword">throw</span> (err.response) ? <span class="hljs-built_in">Error</span>(err.response.body.Error) : err;
        })
    });

    it(<span class="hljs-string">"should error if required params are not present"</span>, () =&gt; {
      <span class="hljs-keyword">let</span> self = <span class="hljs-keyword">this</span>;
      <span class="hljs-keyword">return</span> self.api
        .post(<span class="hljs-string">'/pizzas/add'</span>)
        .set(<span class="hljs-string">'Authorization'</span>, self.user1.token)
        .send({})
        .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
          expect(err.status).to.eql(<span class="hljs-number">500</span>);
          <span class="hljs-keyword">return</span> self.api.post(<span class="hljs-string">'/pizzas/add'</span>)
            .set(<span class="hljs-string">'Authorization'</span>, self.user1.token)
            .send({
              <span class="hljs-attr">name</span>: self.pizza1.name
            })
        })
        .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
          expect(err.status).to.eql(<span class="hljs-number">500</span>);
          <span class="hljs-keyword">return</span> self.api.post(<span class="hljs-string">'/pizzas/add'</span>)
            .set(<span class="hljs-string">'Authorization'</span>, self.user1.token)
            .send({
              <span class="hljs-attr">description</span>: self.pizza1.description,
              <span class="hljs-attr">image</span>: self.pizza1.image
            })
        })
        .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
          expect(err.status).to.eql(<span class="hljs-number">500</span>);
          <span class="hljs-keyword">return</span> self.api.post(<span class="hljs-string">'/pizzas/add'</span>)
            .set(<span class="hljs-string">'Authorization'</span>, self.user1.token)
            .send({
              <span class="hljs-attr">ingredients</span>: self.pizza1.ingredients,
              <span class="hljs-attr">description</span>: self.pizza1.description,
              <span class="hljs-attr">image</span>: self.pizza1.image
            })
        })
        .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
          expect(err.status).to.eql(<span class="hljs-number">500</span>);
        })
    });

    it(<span class="hljs-string">"should error if params haven't good format -- see dto in constants for details"</span>, () =&gt; {
      <span class="hljs-keyword">let</span> self = <span class="hljs-keyword">this</span>;
      <span class="hljs-keyword">return</span> self.api
        .post(<span class="hljs-string">'/pizzas/add'</span>)
        .set(<span class="hljs-string">'Authorization'</span>, self.user1.token)
        .send({})
        .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
          expect(err.status).to.eql(<span class="hljs-number">500</span>);
          <span class="hljs-keyword">return</span> self.api.post(<span class="hljs-string">'/pizzas/add'</span>)
            .set(<span class="hljs-string">'Authorization'</span>, self.user1.token)
            .send({
              <span class="hljs-attr">name</span>: <span class="hljs-number">1</span>
            })
        })
        .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
          expect(err.status).to.eql(<span class="hljs-number">500</span>);
          <span class="hljs-keyword">return</span> self.api.post(<span class="hljs-string">'/pizzas/add'</span>)
            .set(<span class="hljs-string">'Authorization'</span>, self.user1.token)
            .send({
              <span class="hljs-attr">description</span>: <span class="hljs-number">1</span>,
              <span class="hljs-attr">image</span>: <span class="hljs-number">1</span>
            })
        })
        .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
          expect(err.status).to.eql(<span class="hljs-number">500</span>);
          <span class="hljs-keyword">return</span> self.api.post(<span class="hljs-string">'/pizzas/add'</span>)
            .set(<span class="hljs-string">'Authorization'</span>, self.user1.token)
            .send({
              <span class="hljs-attr">ingredients</span>: <span class="hljs-number">1</span>,
              <span class="hljs-attr">description</span>: <span class="hljs-string">"Lorem ipsum dolor sit amet, consectetur adipiscing elit. Curabitur lobortis est gravida lorem posuere lobortis. Sed pulvinar, orci sed vulputate elementum, justo sem vehicula arcu, a mattis est arcu non nulla. Nullam at ipsum luctus, tempus velit non, luctus sapien. Donec porttitor dui eu consequat viverra. Donec est ipsum, interdum sed tristique in, aliquam ut dui. Nunc eget odio at felis semper dignissim quis nec est. Aenean congue, ante sit amet feugiat ultricies, risus leo luctus turpis amet."</span>,
              <span class="hljs-attr">priceCts</span>: self.pizza1.name
            })
        })
        .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
          expect(err.status).to.eql(<span class="hljs-number">500</span>);
        })
    });
  });

  describe(<span class="hljs-string">'/:id -- PUT tests'</span>, () =&gt; {
    before(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
      <span class="hljs-keyword">let</span> self = <span class="hljs-keyword">this</span>;
      self.user1 = {
        <span class="hljs-attr">firstName</span>: <span class="hljs-string">"test1"</span>,
        <span class="hljs-attr">lastName</span>: <span class="hljs-string">"test1"</span>,
        <span class="hljs-attr">email</span>: <span class="hljs-string">"test1@test.com"</span>,
        <span class="hljs-attr">password</span>: <span class="hljs-string">"Testtest1"</span>
      };
      self.pizza1 = {
        <span class="hljs-attr">name</span>: <span class="hljs-string">"pizza1"</span>,
        <span class="hljs-attr">image</span>: <span class="hljs-string">""</span>,
        <span class="hljs-attr">description</span>: <span class="hljs-string">"lorem ipsum1"</span>,
        <span class="hljs-attr">priceCts</span>: <span class="hljs-number">200</span>
      };
      self.pizza2 = {
        <span class="hljs-attr">name</span>: <span class="hljs-string">"pizza2"</span>,
        <span class="hljs-attr">image</span>: <span class="hljs-string">""</span>,
        <span class="hljs-attr">description</span>: <span class="hljs-string">"lorem ipsum2"</span>,
        <span class="hljs-attr">priceCts</span>: <span class="hljs-number">150</span>
      };
      self.ingredient1 = {
        <span class="hljs-attr">name</span>: <span class="hljs-string">"ingredient1"</span>,
        <span class="hljs-attr">weight</span>: <span class="hljs-number">150</span>,
        <span class="hljs-attr">priceCts</span>: <span class="hljs-number">150</span>
      };

      <span class="hljs-keyword">return</span> <span class="hljs-built_in">Promise</span>.all([
        models.Pizza.remove({}),
        models.User.remove({}),
        models.Ingredient.remove({})
      ])

        .then(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
          <span class="hljs-keyword">return</span> models.User.specials.signup(self.user1)
        })
        .then(<span class="hljs-function">(<span class="hljs-params">user</span>) =&gt;</span> {
          self.user1._id = user._id;
          self.pizza1.cook = self.user1._id;
          <span class="hljs-keyword">return</span> models.Ingredient.create(self.ingredient1);
        })
        .then(<span class="hljs-function">(<span class="hljs-params">ingredient</span>) =&gt;</span> {
          self.pizza1.ingredients = [ingredient._id];
          self.pizza2.ingredients = [ingredient._id];
          <span class="hljs-keyword">return</span> models.Pizza.create(self.pizza1);
        })
        .then(<span class="hljs-function">(<span class="hljs-params">pizza</span>) =&gt;</span> {
          self.pizza2.cook = self.user1._id;
          self.pizza1._id = pizza._id;
          <span class="hljs-keyword">return</span> models.Pizza.create(self.pizza2);
        })
        .then(<span class="hljs-function">(<span class="hljs-params">pizza</span>) =&gt;</span> {
          self.pizza2._id = pizza._id;
          <span class="hljs-keyword">return</span> self.api.post(<span class="hljs-string">'/users/signin'</span>)
            .send({
              <span class="hljs-attr">email</span>: self.user1.email,
              <span class="hljs-attr">password</span>: self.user1.password
            })
        })
        .then(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
          self.user1.token = res.body.response;
        })
        .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
          <span class="hljs-keyword">throw</span> (err.response) ? <span class="hljs-built_in">Error</span>(err.response.body.Error) : err;
        })
    });

    it(<span class="hljs-string">"should modify pizza who is passed in param and return user updated"</span>, () =&gt; {
      <span class="hljs-keyword">let</span> self = <span class="hljs-keyword">this</span>;
      <span class="hljs-keyword">return</span> self.api
        .put(<span class="hljs-string">'/pizzas/'</span> + self.pizza1._id)
        .set(<span class="hljs-string">'Authorization'</span>, self.user1.token)
        .send({
          <span class="hljs-attr">name</span>: <span class="hljs-string">"toto"</span>
        })
        .set(<span class="hljs-string">'Authorization'</span>, self.user1.token)
        .then(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
          expect(res.statusCode).to.eql(<span class="hljs-number">200</span>);
          expect(res.body.response.name).to.eql(<span class="hljs-string">"toto"</span>);
          <span class="hljs-keyword">return</span> self.api
            .put(<span class="hljs-string">'/pizzas/'</span> + self.pizza1._id)
            .set(<span class="hljs-string">'Authorization'</span>, self.user1.token)
            .send({
              <span class="hljs-attr">priceCts</span>: <span class="hljs-number">1230</span>
            })
        })
        .then(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
          expect(res.status).to.eql(<span class="hljs-number">200</span>);
          expect(res.body.response.priceCts).to.eql(<span class="hljs-number">1230</span>);
          <span class="hljs-keyword">return</span> self.api
            .put(<span class="hljs-string">'/pizzas/'</span> + self.pizza1._id)
            .set(<span class="hljs-string">'Authorization'</span>, self.user1.token)
            .send({
              <span class="hljs-attr">description</span>: <span class="hljs-string">"toto"</span>,
              <span class="hljs-attr">image</span>: <span class="hljs-string">"tata"</span>
            })
        })
        .then(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
          expect(res.status).to.eql(<span class="hljs-number">200</span>);
          expect(res.body.response.description).to.eql(<span class="hljs-string">"toto"</span>);
          expect(<span class="hljs-keyword">new</span> Buffer(res.body.response.image.data).toString()).to.eql(<span class="hljs-string">"tata"</span>);
        })
        .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
          <span class="hljs-keyword">throw</span> (err.response) ? <span class="hljs-built_in">Error</span>(err.response.body.Error) : err;
        })
    });

    it(<span class="hljs-string">"should error if token is not present"</span>, () =&gt; {
      <span class="hljs-keyword">let</span> self = <span class="hljs-keyword">this</span>;
      <span class="hljs-keyword">return</span> self.api
        .put(<span class="hljs-string">'/pizzas/'</span> + self.pizza1._id)
        .send({
          <span class="hljs-attr">name</span>: <span class="hljs-string">"toto"</span>
        })
        .then(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
          expect(res).to.be.a(<span class="hljs-string">'null'</span>);
        })
        .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
          expect(err.status).to.eql(<span class="hljs-number">403</span>);
        })
    });

    it(<span class="hljs-string">"should error if params haven't good format -- see dto in constants for details"</span>, () =&gt; {
      <span class="hljs-keyword">let</span> self = <span class="hljs-keyword">this</span>;
      <span class="hljs-keyword">return</span> self.api
        .put(<span class="hljs-string">'/pizzas/'</span> + self.pizza1._id)
        .set(<span class="hljs-string">'Authorization'</span>, self.user1.token)
        .send({<span class="hljs-attr">name</span>: <span class="hljs-number">1</span>})
        .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
          expect(err.status).to.eql(<span class="hljs-number">500</span>);
          <span class="hljs-keyword">return</span> self.api.put(<span class="hljs-string">'/pizzas/'</span> + self.pizza1._id)
            .set(<span class="hljs-string">'Authorization'</span>, self.user1.token)
            .send({
              <span class="hljs-attr">priceCts</span>: <span class="hljs-string">"test1.com"</span>
            })
        })
        .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
          expect(err.status).to.eql(<span class="hljs-number">500</span>);
          <span class="hljs-keyword">return</span> self.api.put(<span class="hljs-string">'/pizzas/'</span> + self.pizza1._id)
            .set(<span class="hljs-string">'Authorization'</span>, self.user1.token)
            .send({
              <span class="hljs-attr">ingredients</span>: <span class="hljs-string">"fzefez"</span>
            })
        })
        .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
          expect(err.status).to.eql(<span class="hljs-number">500</span>);
          <span class="hljs-keyword">return</span> self.api.put(<span class="hljs-string">'/pizzas/'</span> + self.pizza1._id)
            .set(<span class="hljs-string">'Authorization'</span>, self.user1.token)
            .send({
              <span class="hljs-attr">description</span>: []
            })
        })
        .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
          expect(err.status).to.eql(<span class="hljs-number">500</span>);
          <span class="hljs-keyword">return</span> self.api.put(<span class="hljs-string">'/pizzas/'</span> + self.pizza1._id)
            .set(<span class="hljs-string">'Authorization'</span>, self.user1.token)
            .send({
              <span class="hljs-attr">image</span>: <span class="hljs-number">12</span>
            })
        })
        .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
          expect(err.status).to.eql(<span class="hljs-number">500</span>);
        })
    });
  });

  describe(<span class="hljs-string">'/:id -- GET tests'</span>, () =&gt; {
    before(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
      <span class="hljs-keyword">let</span> self = <span class="hljs-keyword">this</span>;
      self.user1 = {
        <span class="hljs-attr">firstName</span>: <span class="hljs-string">"test1"</span>,
        <span class="hljs-attr">lastName</span>: <span class="hljs-string">"test1"</span>,
        <span class="hljs-attr">email</span>: <span class="hljs-string">"test1@test.com"</span>,
        <span class="hljs-attr">password</span>: <span class="hljs-string">"Testtest1"</span>
      };
      self.pizza1 = {
        <span class="hljs-attr">name</span>: <span class="hljs-string">"pizza1"</span>,
        <span class="hljs-attr">image</span>: <span class="hljs-string">""</span>,
        <span class="hljs-attr">description</span>: <span class="hljs-string">"lorem ipsum1"</span>,
        <span class="hljs-attr">priceCts</span>: <span class="hljs-number">200</span>
      };
      self.pizza2 = {
        <span class="hljs-attr">name</span>: <span class="hljs-string">"pizza2"</span>,
        <span class="hljs-attr">image</span>: <span class="hljs-string">""</span>,
        <span class="hljs-attr">description</span>: <span class="hljs-string">"lorem ipsum2"</span>,
        <span class="hljs-attr">priceCts</span>: <span class="hljs-number">150</span>
      };
      self.ingredient1 = {
        <span class="hljs-attr">name</span>: <span class="hljs-string">"ingredient1"</span>,
        <span class="hljs-attr">weight</span>: <span class="hljs-number">150</span>,
        <span class="hljs-attr">priceCts</span>: <span class="hljs-number">150</span>
      };

      <span class="hljs-keyword">return</span> <span class="hljs-built_in">Promise</span>.all([
        models.Pizza.remove({}),
        models.User.remove({}),
        models.Ingredient.remove({})
      ])

        .then(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
          <span class="hljs-keyword">return</span> models.User.specials.signup(self.user1)
        })
        .then(<span class="hljs-function">(<span class="hljs-params">user</span>) =&gt;</span> {
          self.user1._id = user._id;
          self.pizza1.cook = self.user1._id;
          <span class="hljs-keyword">return</span> models.Ingredient.create(self.ingredient1);
        })
        .then(<span class="hljs-function">(<span class="hljs-params">ingredient</span>) =&gt;</span> {
          self.pizza1.ingredients = [ingredient._id];
          self.pizza2.ingredients = [ingredient._id];
          <span class="hljs-keyword">return</span> models.Pizza.create(self.pizza1);
        })
        .then(<span class="hljs-function">(<span class="hljs-params">pizza</span>) =&gt;</span> {
          self.pizza2.cook = self.user1._id;
          self.pizza1._id = pizza._id;
          <span class="hljs-keyword">return</span> models.Pizza.create(self.pizza2);
        })
        .then(<span class="hljs-function">(<span class="hljs-params">pizza</span>) =&gt;</span> {
          self.pizza2._id = pizza._id;
          <span class="hljs-keyword">return</span> self.api.post(<span class="hljs-string">'/users/signin'</span>)
            .send({
              <span class="hljs-attr">email</span>: self.user1.email,
              <span class="hljs-attr">password</span>: self.user1.password
            })
        })
        .then(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
          self.user1.token = res.body.response;
        })
        .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
          <span class="hljs-keyword">throw</span> (err.response) ? <span class="hljs-built_in">Error</span>(err.response.body.Error) : err;
        })
    });

    it(<span class="hljs-string">"should return one specific pizza"</span>, () =&gt; {
      <span class="hljs-keyword">let</span> self = <span class="hljs-keyword">this</span>;
      <span class="hljs-keyword">return</span> self.api
        .get(<span class="hljs-string">'/pizzas/'</span> + self.pizza1._id)
        .then(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
          expect(res.statusCode).to.eql(<span class="hljs-number">200</span>);
          expect(res.body.response.name).to.eql(self.pizza1.name);
          expect(res.body.response.description).to.eql(self.pizza1.description);
          expect(res.body.response.priceCts).to.eql(self.pizza1.priceCts);
          expect(res.body.response.ingredients[<span class="hljs-number">0</span>]._id.toString()).to.eql(self.pizza1.ingredients[<span class="hljs-number">0</span>].toString());
        })
        .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
          <span class="hljs-keyword">throw</span> (err.response) ? <span class="hljs-built_in">Error</span>(err.response.body.Error) : err;
        })
    });

    it(<span class="hljs-string">"should return one specific pizza and different of second pizza"</span>, () =&gt; {
      <span class="hljs-keyword">let</span> self = <span class="hljs-keyword">this</span>;
      <span class="hljs-keyword">return</span> self.api
        .get(<span class="hljs-string">'/pizzas/'</span> + self.pizza2._id)
        .then(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
          expect(res.statusCode).to.eql(<span class="hljs-number">200</span>);
          expect(res.body.response.name).to.not.eql(self.pizza1.name);
          expect(res.body.response.description).to.not.eql(self.pizza1.description);
          expect(res.body.response.priceCts).to.not.eql(self.pizza1.priceCts);
          expect(res.body.response.ingredients[<span class="hljs-number">0</span>]._id.toString()).to.eql(self.pizza1.ingredients[<span class="hljs-number">0</span>].toString());
        })
        .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
          <span class="hljs-keyword">throw</span> (err.response) ? <span class="hljs-built_in">Error</span>(err.response.body.Error) : err;
        })
    });

    it(<span class="hljs-string">"should error if id param doesn't have corresponding documents in mongoDB"</span>, () =&gt; {
      <span class="hljs-keyword">let</span> self = <span class="hljs-keyword">this</span>;
      <span class="hljs-keyword">return</span> self.api
        .get(<span class="hljs-string">'/pizzas/'</span> + self.pizza1._id + <span class="hljs-number">1</span>)
        .then(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
          expect(res).to.be.a(<span class="hljs-string">'null'</span>);
        })
        .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
          expect(err.response.status).to.eql(<span class="hljs-number">404</span>);
        })
    });

  });

  describe(<span class="hljs-string">'/:id -- DELETE tests'</span>, () =&gt; {
    before(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
      <span class="hljs-keyword">let</span> self = <span class="hljs-keyword">this</span>;
      self.user1 = {
        <span class="hljs-attr">firstName</span>: <span class="hljs-string">"test1"</span>,
        <span class="hljs-attr">lastName</span>: <span class="hljs-string">"test1"</span>,
        <span class="hljs-attr">email</span>: <span class="hljs-string">"test1@test.com"</span>,
        <span class="hljs-attr">password</span>: <span class="hljs-string">"Testtest1"</span>
      };
      self.pizza1 = {
        <span class="hljs-attr">name</span>: <span class="hljs-string">"pizza1"</span>,
        <span class="hljs-attr">image</span>: <span class="hljs-string">""</span>,
        <span class="hljs-attr">description</span>: <span class="hljs-string">"lorem ipsum1"</span>,
        <span class="hljs-attr">priceCts</span>: <span class="hljs-number">200</span>
      };
      self.pizza2 = {
        <span class="hljs-attr">name</span>: <span class="hljs-string">"pizza2"</span>,
        <span class="hljs-attr">image</span>: <span class="hljs-string">""</span>,
        <span class="hljs-attr">description</span>: <span class="hljs-string">"lorem ipsum2"</span>,
        <span class="hljs-attr">priceCts</span>: <span class="hljs-number">150</span>
      };
      self.ingredient1 = {
        <span class="hljs-attr">name</span>: <span class="hljs-string">"ingredient1"</span>,
        <span class="hljs-attr">weight</span>: <span class="hljs-number">150</span>,
        <span class="hljs-attr">priceCts</span>: <span class="hljs-number">150</span>
      };

      <span class="hljs-keyword">return</span> <span class="hljs-built_in">Promise</span>.all([
        models.Pizza.remove({}),
        models.User.remove({}),
        models.Ingredient.remove({})
      ])

        .then(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
          <span class="hljs-keyword">return</span> models.User.specials.signup(self.user1)
        })
        .then(<span class="hljs-function">(<span class="hljs-params">user</span>) =&gt;</span> {
          self.user1._id = user._id;
          self.pizza1.cook = self.user1._id;
          <span class="hljs-keyword">return</span> models.Ingredient.create(self.ingredient1);
        })
        .then(<span class="hljs-function">(<span class="hljs-params">ingredient</span>) =&gt;</span> {
          self.pizza1.ingredients = [ingredient._id];
          self.pizza2.ingredients = [ingredient._id];
          <span class="hljs-keyword">return</span> models.Pizza.create(self.pizza1);
        })
        .then(<span class="hljs-function">(<span class="hljs-params">pizza</span>) =&gt;</span> {
          self.pizza2.cook = self.user1._id;
          self.pizza1._id = pizza._id;
          <span class="hljs-keyword">return</span> models.Pizza.create(self.pizza2);
        })
        .then(<span class="hljs-function">(<span class="hljs-params">pizza</span>) =&gt;</span> {
          self.pizza2._id = pizza._id;
          <span class="hljs-keyword">return</span> self.api.post(<span class="hljs-string">'/users/signin'</span>)
            .send({
              <span class="hljs-attr">email</span>: self.user1.email,
              <span class="hljs-attr">password</span>: self.user1.password
            })
        })
        .then(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
          self.user1.token = res.body.response;
        })
        .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
          <span class="hljs-keyword">throw</span> (err.response) ? <span class="hljs-built_in">Error</span>(err.response.body.Error) : err;
        })
    });

    it(<span class="hljs-string">"should remove one specific pizza"</span>, () =&gt; {
      <span class="hljs-keyword">let</span> self = <span class="hljs-keyword">this</span>;
      <span class="hljs-keyword">return</span> self.api
        .del(<span class="hljs-string">'/pizzas/'</span> + self.pizza1._id)
        .set(<span class="hljs-string">'Authorization'</span>, self.user1.token)
        .then(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
          expect(res.statusCode).to.eql(<span class="hljs-number">200</span>);
          expect(res.body.response).to.eql(<span class="hljs-literal">true</span>);
        })
        .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
          <span class="hljs-keyword">throw</span> (err.response) ? <span class="hljs-built_in">Error</span>(err.response.body.Error) : err;
        })
    });

    it(<span class="hljs-string">"should error if id param doesn't have corresponding documents in mongoDB"</span>, () =&gt; {
      <span class="hljs-keyword">let</span> self = <span class="hljs-keyword">this</span>;
      <span class="hljs-keyword">return</span> self.api
        .del(<span class="hljs-string">'/pizzas/'</span> + self.pizza1._id + <span class="hljs-number">1</span>)
        .set(<span class="hljs-string">'Authorization'</span>, self.user1.token)
        .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
          expect(err.status).to.eql(<span class="hljs-number">404</span>);
        })
    });

    it(<span class="hljs-string">"should error if token is not present"</span>, () =&gt; {
      <span class="hljs-keyword">let</span> self = <span class="hljs-keyword">this</span>;
      <span class="hljs-keyword">return</span> self.api
        .del(<span class="hljs-string">'/pizzas/'</span> + self.pizza1._id)
        .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
          expect(err.status).to.eql(<span class="hljs-number">403</span>);
          expect(err.response.body).to.eql({<span class="hljs-string">"error"</span>: <span class="hljs-string">"Token missing"</span>});
        })
    });
  });

  describe(<span class="hljs-string">'Socket tests -- WITH INGREDIENTS ONLY BECAUSE SAME ON PIZZAS'</span>, () =&gt; {
    describe(<span class="hljs-string">'On add'</span>, () =&gt; {
      before(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
        <span class="hljs-keyword">let</span> self = <span class="hljs-keyword">this</span>;
        self.io = socketClient.connect(config.socket.host);
        self.user1 = {
          <span class="hljs-attr">firstName</span>: <span class="hljs-string">"test1"</span>,
          <span class="hljs-attr">lastName</span>: <span class="hljs-string">"test1"</span>,
          <span class="hljs-attr">email</span>: <span class="hljs-string">"test1@test.com"</span>,
          <span class="hljs-attr">password</span>: <span class="hljs-string">"Testtest1"</span>
        };
        self.ingredient1 = {
          <span class="hljs-attr">name</span>: <span class="hljs-string">"ingredient1"</span>,
          <span class="hljs-attr">weight</span>: <span class="hljs-number">150</span>,
          <span class="hljs-attr">priceCts</span>: <span class="hljs-number">150</span>
        };
        self.ingredient2 = {
          <span class="hljs-attr">name</span>: <span class="hljs-string">"ingredient2"</span>,
          <span class="hljs-attr">weight</span>: <span class="hljs-number">180</span>,
          <span class="hljs-attr">priceCts</span>: <span class="hljs-number">180</span>
        };

        <span class="hljs-keyword">return</span> <span class="hljs-built_in">Promise</span>.all([
          models.Pizza.remove({}),
          models.User.remove({}),
          models.Ingredient.remove({})
        ])

          .then(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
            <span class="hljs-keyword">return</span> models.User.specials.signup(self.user1)
          })
          .then(<span class="hljs-function">(<span class="hljs-params">token</span>) =&gt;</span> {
            <span class="hljs-keyword">return</span> tools.verifyJWTAsync(token);
          })
          .then(<span class="hljs-function">(<span class="hljs-params">decoded</span>) =&gt;</span> {
            self.user1._id = decoded.id;
            <span class="hljs-keyword">return</span> self.api.post(<span class="hljs-string">'/users/signin'</span>)
              .send({
                <span class="hljs-attr">email</span>: self.user1.email,
                <span class="hljs-attr">password</span>: self.user1.password
              })
          })
          .then(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
            self.user1.token = res.body.response;
          })
          .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
            <span class="hljs-keyword">throw</span> (err.response) ? <span class="hljs-built_in">Error</span>(err.response.body.Error) : err;
          })
      });

      it(<span class="hljs-string">"should emit to all client the add"</span>, (done) =&gt; {
        <span class="hljs-keyword">let</span> self = <span class="hljs-keyword">this</span>;
        self.io.on(<span class="hljs-string">'ingredient'</span>, (ingredient) =&gt; {
          expect(ingredient.type).to.eql(<span class="hljs-string">'add'</span>);
          done();
        });
        self.api
          .post(<span class="hljs-string">'/ingredients/add'</span>)
          .send(self.ingredient1)
          .set(<span class="hljs-string">'Authorization'</span>, self.user1.token)
          .then(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
            <span class="hljs-keyword">let</span> ingredient = res.body.response;
            expect(res.statusCode).to.eql(<span class="hljs-number">200</span>);
            expect(ingredient.name).to.eql(self.ingredient1.name);
            expect(ingredient.weight).to.eql(self.ingredient1.weight);
            expect(ingredient.priceCts).to.eql(self.ingredient1.priceCts);
          })
          .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
            <span class="hljs-keyword">throw</span> (err.response) ? <span class="hljs-built_in">Error</span>(err.response.body.Error) : err;
          })

      });

      it(<span class="hljs-string">"should not emit to all client if add not made"</span>, (done) =&gt; {
        <span class="hljs-keyword">let</span> self = <span class="hljs-keyword">this</span>;
        self.io.on(<span class="hljs-string">'ingredient'</span>, (ingredient) =&gt; {
          <span class="hljs-keyword">throw</span> <span class="hljs-string">"Error: socket received but not expected"</span>;
        });
        self.api
          .post(<span class="hljs-string">'/ingredients/add'</span>)
          .send(self.ingredient1)
          .set(<span class="hljs-string">'Authorization'</span>, self.user1.token)
          .then(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
            <span class="hljs-keyword">let</span> ingredient = res.body.response;
            expect(res.statusCode).to.eql(<span class="hljs-number">200</span>);
            expect(ingredient.name).to.eql(self.ingredient1.name);
            expect(ingredient.weight).to.eql(self.ingredient1.weight);
            expect(ingredient.priceCts).to.eql(self.ingredient1.priceCts);
          })
          .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
            <span class="hljs-keyword">return</span>;
          })
          .then(<span class="hljs-function"><span class="hljs-params">()</span>=&gt;</span>{
            setTimeout(<span class="hljs-function"><span class="hljs-params">()</span>=&gt;</span>{
              done();
            }, <span class="hljs-number">500</span>)
          })

      });

      after(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
        <span class="hljs-keyword">let</span> self = <span class="hljs-keyword">this</span>;
        self.io.disconnect();
      });
    });

    describe(<span class="hljs-string">'On update'</span>, () =&gt; {
      before(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
        <span class="hljs-keyword">let</span> self = <span class="hljs-keyword">this</span>;
        self.io = socketClient.connect(config.socket.host);
        self.user1 = {
          <span class="hljs-attr">firstName</span>: <span class="hljs-string">"test1"</span>,
          <span class="hljs-attr">lastName</span>: <span class="hljs-string">"test1"</span>,
          <span class="hljs-attr">email</span>: <span class="hljs-string">"test1@test.com"</span>,
          <span class="hljs-attr">password</span>: <span class="hljs-string">"Testtest1"</span>
        };
        self.ingredient1 = {
          <span class="hljs-attr">name</span>: <span class="hljs-string">"ingredient1"</span>,
          <span class="hljs-attr">weight</span>: <span class="hljs-number">200</span>,
          <span class="hljs-attr">priceCts</span>: <span class="hljs-number">200</span>
        };
        self.ingredient2 = {
          <span class="hljs-attr">name</span>: <span class="hljs-string">"ingredient2"</span>,
          <span class="hljs-attr">weight</span>: <span class="hljs-number">150</span>,
          <span class="hljs-attr">priceCts</span>: <span class="hljs-number">150</span>
        };

        <span class="hljs-keyword">return</span> <span class="hljs-built_in">Promise</span>.all([
          models.Pizza.remove({}),
          models.User.remove({}),
          models.Ingredient.remove({})
        ])
          .then(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
            <span class="hljs-keyword">return</span> models.User.specials.signup(self.user1)
          })
          .then(<span class="hljs-function">(<span class="hljs-params">user</span>) =&gt;</span> {
            self.user1._id = user._id;
            <span class="hljs-keyword">return</span> models.Ingredient.create(self.ingredient1);
          })
          .then(<span class="hljs-function">(<span class="hljs-params">ingredient</span>) =&gt;</span> {
            self.ingredient1._id = ingredient._id;
            <span class="hljs-keyword">return</span> models.Ingredient.create(self.ingredient2);
          })
          .then(<span class="hljs-function">(<span class="hljs-params">ingredient</span>) =&gt;</span> {
            self.ingredient2._id = ingredient._id;
            <span class="hljs-keyword">return</span> self.api.post(<span class="hljs-string">'/users/signin'</span>)
              .send({
                <span class="hljs-attr">email</span>: self.user1.email,
                <span class="hljs-attr">password</span>: self.user1.password
              })
          })
          .then(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
            self.user1.token = res.body.response;
          })
          .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
            <span class="hljs-keyword">throw</span> (err.response) ? <span class="hljs-built_in">Error</span>(err.response.body.Error) : err;
          })
      });

      it(<span class="hljs-string">"should emit to all client the update"</span>, (done) =&gt; {
        <span class="hljs-keyword">let</span> self = <span class="hljs-keyword">this</span>;
        self.io.on(<span class="hljs-string">'ingredient'</span>, (ingredient) =&gt; {
          expect(ingredient.type).to.eql(<span class="hljs-string">'update'</span>);
          done();
        });
        self.api
          .put(<span class="hljs-string">'/ingredients/'</span> + self.ingredient1._id)
          .send({
            <span class="hljs-attr">name</span>: self.ingredient1.name + <span class="hljs-string">" test"</span>,
            <span class="hljs-attr">weight</span>: self.ingredient1.weight + <span class="hljs-number">1</span>,
            <span class="hljs-attr">priceCts</span>: self.ingredient1.priceCts + <span class="hljs-number">1</span>
          })
          .set(<span class="hljs-string">'Authorization'</span>, self.user1.token)
          .then(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
            expect(res.status).to.eql(<span class="hljs-number">200</span>);
          })
          .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
            <span class="hljs-keyword">throw</span> (err.response) ? <span class="hljs-built_in">Error</span>(err.response.body.Error) : err;
          })
      });

      it(<span class="hljs-string">"should not emit to all client if update not made"</span>, (done) =&gt; {
        <span class="hljs-keyword">let</span> self = <span class="hljs-keyword">this</span>;
        self.io.on(<span class="hljs-string">'ingredient'</span>, (ingredient) =&gt; {
          <span class="hljs-keyword">throw</span> <span class="hljs-string">"Error: socket received but not expected"</span>;
        });
        self.api
          .put(<span class="hljs-string">'/ingredients/'</span> + self.ingredient1._id)
          .send({
            <span class="hljs-attr">name</span>: self.ingredient1.name + <span class="hljs-string">" test"</span>,
            <span class="hljs-attr">weight</span>: self.ingredient1.weight + <span class="hljs-number">1</span>,
            <span class="hljs-attr">priceCts</span>: self.ingredient1.priceCts + <span class="hljs-number">1</span>
          })
          .then(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
            expect(res.status).to.eql(<span class="hljs-number">200</span>);
          })
          .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
            <span class="hljs-keyword">return</span>;
          })
          .then(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
            setTimeout(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
              done();
            }, <span class="hljs-number">500</span>);
          })
      });

      after(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
        <span class="hljs-keyword">let</span> self = <span class="hljs-keyword">this</span>;
        self.io.disconnect();
      });
    });

    describe(<span class="hljs-string">'On remove'</span>, () =&gt; {
      before(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
        <span class="hljs-keyword">let</span> self = <span class="hljs-keyword">this</span>;
        self.io = socketClient.connect(config.socket.host);
        self.user1 = {
          <span class="hljs-attr">firstName</span>: <span class="hljs-string">"test1"</span>,
          <span class="hljs-attr">lastName</span>: <span class="hljs-string">"test1"</span>,
          <span class="hljs-attr">email</span>: <span class="hljs-string">"test1@test.com"</span>,
          <span class="hljs-attr">password</span>: <span class="hljs-string">"Testtest1"</span>
        };
        self.ingredient1 = {
          <span class="hljs-attr">name</span>: <span class="hljs-string">"ingredient1"</span>,
          <span class="hljs-attr">weight</span>: <span class="hljs-number">200</span>,
          <span class="hljs-attr">priceCts</span>: <span class="hljs-number">200</span>
        };
        self.ingredient2 = {
          <span class="hljs-attr">name</span>: <span class="hljs-string">"ingredient2"</span>,
          <span class="hljs-attr">weight</span>: <span class="hljs-number">150</span>,
          <span class="hljs-attr">priceCts</span>: <span class="hljs-number">150</span>
        };

        <span class="hljs-keyword">return</span> <span class="hljs-built_in">Promise</span>.all([
          models.Pizza.remove({}),
          models.User.remove({}),
          models.Ingredient.remove({})
        ])
          .then(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
            <span class="hljs-keyword">return</span> models.User.specials.signup(self.user1)
          })
          .then(<span class="hljs-function">(<span class="hljs-params">user</span>) =&gt;</span> {
            self.user1._id = user._id;
            <span class="hljs-keyword">return</span> models.Ingredient.create(self.ingredient1);
          })
          .then(<span class="hljs-function">(<span class="hljs-params">ingredient</span>) =&gt;</span> {
            self.ingredient1._id = ingredient._id;
            <span class="hljs-keyword">return</span> models.Ingredient.create(self.ingredient2);
          })
          .then(<span class="hljs-function">(<span class="hljs-params">ingredient</span>) =&gt;</span> {
            self.ingredient2._id = ingredient._id;
            <span class="hljs-keyword">return</span> self.api.post(<span class="hljs-string">'/users/signin'</span>)
              .send({
                <span class="hljs-attr">email</span>: self.user1.email,
                <span class="hljs-attr">password</span>: self.user1.password
              })
          })
          .then(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
            self.user1.token = res.body.response;
          })
          .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
            <span class="hljs-keyword">throw</span> (err.response) ? <span class="hljs-built_in">Error</span>(err.response.body.Error) : err;
          })
      });

      it(<span class="hljs-string">"should emit to all client the remove"</span>, (done) =&gt; {
        <span class="hljs-keyword">let</span> self = <span class="hljs-keyword">this</span>;
        self.io.on(<span class="hljs-string">'ingredient'</span>, (ingredient) =&gt; {
          expect(ingredient.type).to.eql(<span class="hljs-string">'remove'</span>);
          done();
        });
        self.api
          .del(<span class="hljs-string">'/ingredients/'</span> + self.ingredient1._id)
          .set(<span class="hljs-string">'Authorization'</span>, self.user1.token)
          .then(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
            expect(res.statusCode).to.eql(<span class="hljs-number">200</span>);
          })
          .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
            <span class="hljs-keyword">throw</span> (err.response) ? <span class="hljs-built_in">Error</span>(err.response.body.Error) : err;
          })
      });

      it(<span class="hljs-string">"should not emit to all client if remove not made"</span>, (done) =&gt; {
        <span class="hljs-keyword">let</span> self = <span class="hljs-keyword">this</span>;
        self.io.on(<span class="hljs-string">'ingredient'</span>, (ingredient) =&gt; {
          <span class="hljs-keyword">throw</span> <span class="hljs-string">"Error: socket received but not expected"</span>;
        });
        self.api
          .del(<span class="hljs-string">'/ingredients/'</span> + self.ingredient1._id)
          .then(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
            expect(res.statusCode).to.eql(<span class="hljs-number">200</span>);
          })
          .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
            <span class="hljs-keyword">return</span>;
          })
          .then(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
            setTimeout(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
              done();
            }, <span class="hljs-number">500</span>);
          })
      });

      after(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
        <span class="hljs-keyword">let</span> self = <span class="hljs-keyword">this</span>;
        self.io.disconnect();
      });
    });
  });

});</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
